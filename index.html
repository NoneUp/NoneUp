<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Гра 2048</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: #121212;
            color: white;
            height: 100vh;
            overflow-x: hidden;
            position: relative;
            transition: background 0.3s, color 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        body.light {
            background: #f5f5f5;
            color: #222;
        }

        /* Стилі для гри 2048 */
        h1 { margin-bottom: 10px; }
        .info { margin-bottom: 15px; font-size: 18px; }

        .grid {
            display: grid;
            grid-template-columns: repeat(4, 80px);
            grid-gap: 10px;
            background: #bbada0;
            padding: 10px;
            border-radius: 10px;
        }

        .tile {
            width: 80px;
            height: 80px;
            background: #cdc1b4;
            font-size: 24px;
            font-weight: bold;
            color: #776e65;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 5px;
            transition: background 0.2s ease;
        }

        .tile[data-val='2']    { background: #eee4da; }
        .tile[data-val='4']    { background: #ede0c8; }
        .tile[data-val='8']    { background: #f2b179; color: #fff; }
        .tile[data-val='16']   { background: #f59563; color: #fff; }
        .tile[data-val='32']   { background: #f67c5f; color: #fff; }
        .tile[data-val='64']   { background: #f65e3b; color: #fff; }
        .tile[data-val='128']  { background: #edcf72; color: #fff; }
        .tile[data-val='256']  { background: #edcc61; color: #fff; }
        .tile[data-val='512']  { background: #edc850; color: #fff; }
        .tile[data-val='1024'] { background: #edc53f; color: #fff; }
        .tile[data-val='2048'] { background: #edc22e; color: #fff; }

        .btn {
            margin-top: 10px;
            padding: 8px 16px;
            font-size: 16px;
            background: #8f7a66;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #game-over {
            margin-top: 20px;
            font-size: 22px;
            color: red;
            font-weight: bold;
        }

        @media (max-width: 500px) {
            .grid {
                grid-template-columns: repeat(4, 60px);
                grid-gap: 8px;
            }

            .tile {
                width: 60px;
                height: 60px;
                font-size: 18px;
            }
        }

        /* Стилі для кнопок та модалок */
        #topButtons {
            position: fixed;
            top: 10px;
            left: 10px;
            display: flex;
            gap: 10px;
            z-index: 3000;
        }
        button {
            background: #444;
            border: none;
            border-radius: 5px;
            padding: 6px 12px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            user-select: none;
            display: flex;
            align-items: center;
            position: relative;
        }
        button:hover {
            background: #666;
        }
        button:focus {
            outline: 2px solid #aaa;
        }
        #settingsBtn {
            font-size: 18px;
            width: 34px;
            justify-content: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: clip;
            padding: 0;
        }
        #settingsBtn span {
            display: block;
            width: 100%;
            text-align: center;
        }

        /* Нова стилі для кнопки Play/Pause зверху */
        #playPauseBtnTop {
            font-size: 18px; /* Розмір за замовчуванням */
            width: 34px;
            justify-content: center;
            padding: 0;
            display: none; /* Прихована за замовчуванням */
            box-sizing: border-box;
        }
        #playPauseBtnTop span {
            display: block;
            width: 100%;
            text-align: center;
            line-height: 1;
        }
        #playPauseBtnTop.play-icon {
            font-size: 20px; /* Трикутник може бути трохи більшим */
        }
        #playPauseBtnTop.pause-icon {
            font-size: 16px; /* Дві палички можуть бути меншими */
        }


        /* Модалки */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2500;
            padding: 20px;
        }
        .modal {
            background: #222;
            border-radius: 10px;
            max-width: 400px;
            width: 100%;
            padding: 20px 20px 20px 20px;
            position: relative;
            box-shadow: 0 0 20px #000;
            color: white;
            box-sizing: border-box;
        }
        body.light .modal {
            background: #fff;
            color: #222;
            box-shadow: 0 0 20px #aaa;
        }

        .modal h2 {
            margin-top: 0;
            margin-right: 40px;
            word-break: break-word;
        }

        .close-btn {
            position: absolute;
            right: 15px;
            top: 10px;
            font-size: 26px;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            user-select: none;
            line-height: 1;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .close-btn:hover {
            color: #ccc;
        }
        body.light .close-btn {
            color: #222;
        }
        body.light .close-btn:hover {
            color: #555;
        }

        /* Оновлений стиль для кнопки "Назад" в модалці Управління */
        #controlsBackBtn {
            right: 10px; /* Змінено для кращого розташування */
            top: 10px;
            font-size: 24px; /* Збільшений розмір стрілки */
            position: absolute;
            color: white;
            background: transparent;
            border: none;
            cursor: pointer;
            user-select: none;
            padding: 0; /* Важливо: прибрати будь-які внутрішні відступи */
            width: 34px; /* Зробити її співрозмірною з іншими верхніми кнопками */
            height: 34px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-sizing: border-box; /* Врахувати padding у загальному розмірі */
        }
        body.light #controlsBackBtn {
            color: #222;
        }
        body.light #controlsBackBtn:hover {
            color: #555;
        }

        .mini-popup {
            position: absolute;
            top: 38px;
            left: 0;
            background: #222;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.7);
            padding: 10px;
            display: none;
            flex-direction: column;
            gap: 8px;
            min-width: 130px;
            z-index: 4000;
        }
        body.light .mini-popup {
            background: #eee;
            color: #222;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
        }
        .mini-popup button {
            background: transparent;
            color: inherit;
            padding: 6px 10px;
            border-radius: 5px;
            text-align: left;
        }
        .mini-popup button:hover {
            background: #555;
            color: white;
        }
        body.light .mini-popup button:hover {
            background: #ccc;
            color: #222;
        }
    </style>
</head>
<body>

    <div id="topButtons">
        <button id="rulesBtn" data-lang-key="rulesButton">?</button>
        <button id="playPauseBtnTop" title="Продовжити/Пауза"><span aria-hidden="true"></span></button>
        <button id="settingsBtn" title="Налаштування"><span aria-hidden="true">&#9881;</span></button>
    </div>

    <h1 data-lang-key="gameTitle">2048</h1>
    <div class="info"><span data-lang-key="scoreLabel">Очки</span>: <span id="score">0</span> | <span data-lang-key="bestLabel">Рекорд</span>: <span id="best">0</span></div>
    <div class="grid" id="grid"></div>
    <button class="btn" id="start" data-lang-key="startButton">Грати</button>
    <div id="game-over"></div>

    <div id="rulesModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="rulesTitle">
        <div class="modal">
            <button class="close-btn" aria-label="Закрити">&times;</button>
            <h2 id="rulesTitle" data-lang-key="rulesTitle">Правила гри 2048</h2>
            <p><strong data-lang-key="pcLabel">На ПК:</strong> <span data-lang-key="pcControls">керуй грою за допомогою стрілок: ← ↑ → ↓ або WASD.</span></p>
            <p><strong data-lang-key="phoneLabel">На телефоні:</strong> <span data-lang-key="phoneControls">керуй грою свайпами вгору, вниз, вліво та вправо.</span></p>
            <p><span data-lang-key="gameGoal">З'єднуй однакові числа, щоб отримати 2048 і виграти гру!</span></p>
        </div>
    </div>

    <div id="settingsModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
        <div class="modal">
            <button class="close-btn" aria-label="Закрити">&times;</button>
            <h2 id="settingsTitle" data-lang-key="settingsTitle">Налаштування</h2>
            <button id="controlsBtn" style="margin-top: 15px;" data-lang-key="controlsButton">Управління</button>
            <div style="margin-top: 20px;">
                <div style="position: relative; margin-bottom: 15px;">
                    <button id="langBtn" data-lang-key="languageButton">Мова ▼</button>
                    <div id="langPopup" class="mini-popup" role="listbox" aria-label="Вибір мови">
                        <button data-lang="zh">中文 (Китайська)</button>
                        <button data-lang="uk">Українська</button>
                        <button data-lang="ja">日本語 (Японська)</button>
                        <button data-lang="en">English</button>
                    </div>
                </div>
                <div style="position: relative;">
                    <button id="themeBtn" data-lang-key="themeButton">Тема ▼</button>
                    <div id="themePopup" class="mini-popup" role="listbox" aria-label="Вибір теми">
                        <button data-theme="dark" data-lang-key="darkTheme">Темна тема</button>
                        <button data-theme="light" data-lang-key="lightTheme">Світла тема</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="controlsModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="controlsTitle">
        <div class="modal">
            <button id="controlsBackBtn" aria-label="Повернутися">←</button>
            <h2 id="controlsTitle" data-lang-key="controlsTitle">Управління</h2>
            <p><strong data-lang-key="pcLabel">ПК:</strong></p>
            <ul>
                <li><span data-lang-key="arrows">Стрілки: ← ↑ → ↓</span></li>
            </ul>
            <p><strong data-lang-key="phoneLabel">Телефон:</strong></p>
            <ul>
                <li><span data-lang-key="swipes">Свайпи вгору, вниз, вліво, вправо</span></li>
            </ul>
        </div>
    </div>

    <script>
        // JS для гри 2048
        const grid = document.getElementById("grid");
        const scoreDisplay = document.getElementById("score");
        const bestDisplay = document.getElementById("best");
        const gameOverDisplay = document.getElementById("game-over");

        const startBtn = document.getElementById("start"); // Кнопка "Грати" внизу
        const playPauseBtnTop = document.getElementById("playPauseBtnTop"); // Єдина кнопка Play/Pause зверху

        let size = 4;
        let tiles = [];
        let paused = true; // Гра починається на паузі
        let gameStarted = false; // Чи гра була хоча б раз запущена
        let gameOver = false; // Чи гра завершена (програш або виграш)
        let currentScore = 0;

        // Функція, яка керує видимістю та іконкою кнопки Play/Pause
        function updateButtonVisibility() {
            if (gameOver || !gameStarted) {
                // Якщо гра завершена або ще не починалася, показуємо велику кнопку "Грати"
                startBtn.style.display = 'block';
                playPauseBtnTop.style.display = 'none'; // Ховаємо верхню Play/Pause
            } else if (paused) {
                // Якщо гра на паузі, показуємо верхню кнопку з іконкою "Play"
                startBtn.style.display = 'none';
                playPauseBtnTop.style.display = 'flex';
                playPauseBtnTop.classList.remove('pause-icon');
                playPauseBtnTop.classList.add('play-icon');
                playPauseBtnTop.querySelector('span').innerHTML = '&#9658;'; // Іконка трикутника
                playPauseBtnTop.title = translations[currentLang]['playButtonTitle']; // Оновлюємо title
            } else {
                // Якщо гра активна, показуємо верхню кнопку з іконкою "Pause"
                startBtn.style.display = 'none';
                playPauseBtnTop.style.display = 'flex';
                playPauseBtnTop.classList.remove('play-icon');
                playPauseBtnTop.classList.add('pause-icon');
                playPauseBtnTop.querySelector('span').innerHTML = '&#9646;&#9646;'; // Іконка двох паличок
                playPauseBtnTop.title = translations[currentLang]['pauseButtonTitle']; // Оновлюємо title
            }
        }

        // Функція для ініціалізації НОВОЇ гри
        function setupNewGame() {
            grid.innerHTML = '';
            tiles = [];
            for (let i = 0; i < size * size; i++) {
                const tile = document.createElement("div");
                tile.className = "tile";
                tile.dataset.val = '';
                tile.textContent = '';
                grid.appendChild(tile);
                tiles.push(tile);
            }
            addRandomTile();
            addRandomTile();
            updateScore(0);
            gameOverDisplay.textContent = ''; // Очищаємо текст "Гру завершено!"
            updateTileStyles();

            paused = false; // Гра активна після запуску нової
            gameStarted = true; // Гра почалася
            gameOver = false;
            updateButtonVisibility(); // Оновлюємо видимість кнопок
        }

        // Функція для продовження гри після паузи
        function continueGame() {
            if (gameOver || !gameStarted) return; // Не можна продовжувати завершену або не почату гру
            paused = false;
            updateButtonVisibility(); // Оновлюємо видимість кнопок
        }

        // Функція для постановки гри на паузу
        function pauseGame() {
            if (gameOver || !gameStarted) return; // Не можна ставити на паузу завершену або не почату гру
            paused = true;
            updateButtonVisibility(); // Оновлюємо видимість кнопок
        }

        function addRandomTile() {
            const empty = tiles.filter(t => t.textContent === '');
            if (empty.length === 0) return;
            const tile = empty[Math.floor(Math.random() * empty.length)];
            tile.textContent = Math.random() < 0.9 ? 2 : 4;
            updateTileStyles();
        }

        function updateTileStyles() {
            tiles.forEach(tile => {
                tile.dataset.val = tile.textContent || '';
            });
        }

        function merge(line) {
            let result = [];
            for (let i = 0; i < line.length; i++) {
                if (line[i] === null) continue;
                if (line[i] === line[i + 1]) {
                    result.push(line[i] * 2);
                    updateScore(currentScore + line[i] * 2);
                    i++;
                } else {
                    result.push(line[i]);
                }
            }
            while (result.length < size) result.push(null);
            return result;
        }

        function move(dir) {
            if (paused || gameOver) return; // Якщо гра на паузі або завершена, рух не відбувається
            let moved = false;

            if (dir === 'up' || dir === 'down') {
                for (let col = 0; col < size; col++) {
                    let column = [];
                    for (let row = 0; row < size; row++) {
                        const i = row * size + col;
                        const val = parseInt(tiles[i].textContent) || null;
                        if (val) column.push(val);
                    }
                    if (dir === 'down') column.reverse();
                    const merged = merge(column);
                    if (dir === 'down') merged.reverse();
                    for (let row = 0; row < size; row++) {
                        const i = row * size + col;
                        const prev = tiles[i].textContent;
                        tiles[i].textContent = merged[row] || '';
                        if (prev !== tiles[i].textContent) moved = true;
                    }
                }
            } else {
                for (let row = 0; row < size; row++) {
                    let line = [];
                    for (let col = 0; col < size; col++) {
                        const i = row * size + col;
                        const val = parseInt(tiles[i].textContent) || null;
                        if (val) line.push(val);
                    }
                    if (dir === 'right') line.reverse();
                    const merged = merge(line);
                    if (dir === 'right') merged.reverse();
                    for (let col = 0; col < size; col++) {
                        const i = row * size + col;
                        const prev = tiles[i].textContent;
                        tiles[i].textContent = merged[col] || '';
                        if (prev !== tiles[i].textContent) moved = true;
                    }
                }
            }

            if (moved) {
                addRandomTile();
                updateTileStyles();
                if (isGameOver()) showGameOver();
            }
        }

        function isGameOver() {
            // Перевіряємо на виграш (2048 плитка) - це також завершення гри
            if (tiles.some(tile => parseInt(tile.textContent) === 2048)) {
                // gameOverDisplay.textContent = translations[currentLang]['winMessage']; // Можна додати повідомлення про виграш, якщо потрібно
                return true;
            }

            const copy = tiles.map(t => parseInt(t.textContent) || 0);
            for (let i = 0; i < size * size; i++) {
                if (copy[i] === 0) return false; // Є порожні клітинки
                const x = i % size;
                const y = Math.floor(i / size);
                if (x < size - 1 && copy[i] === copy[i + 1]) return false; // Є можливі ходи по горизонталі
                if (y < size - 1 && copy[i] === copy[i + size]) return false; // Є можливі ходи по вертикалі
            }
            return true; // Немає порожніх клітинок і немає можливих ходів
        }

        function showGameOver() {
            // gameOverDisplay.textContent = translations[currentLang]['gameOverMessage']; // Цей рядок прибрано!
            gameOver = true; // Встановлюємо статус "гра завершена"
            paused = true; // Ставимо гру на паузу
            gameStarted = false; // Гра більше не вважається "початою" (для управління кнопками)
            updateButtonVisibility(); // Оновлюємо видимість кнопок
        }

        function updateScore(score = 0) {
            currentScore = score;
            scoreDisplay.textContent = currentScore;
            const best = Math.max(score, parseInt(localStorage.getItem("best") || 0));
            localStorage.setItem("best", best);
            bestDisplay.textContent = best;
        }

        // Обробник натискання клавіш
        document.addEventListener("keydown", e => {
            if (paused || gameOver) return;
            if (e.key === "ArrowUp" || e.key === "w" || e.key === "W") move("up");
            if (e.key === "ArrowDown" || e.key === "s" || e.key === "S") move("down");
            if (e.key === "ArrowLeft" || e.key === "a" || e.key === "A") move("left");
            if (e.key === "ArrowRight" || e.key === "d" || e.key === "D") move("right");
        });

        // Підтримка свайпів
        let startX, startY;
        document.addEventListener("touchstart", e => {
            if (paused || gameOver) return; // Не реагуємо на свайпи, якщо гра на паузі/завершена
            const touch = e.touches[0];
            startX = touch.clientX;
            startY = touch.clientY;
        });

        document.addEventListener("touchend", e => {
            if (paused || gameOver) return; // Не реагуємо на свайпи, якщо гра на паузі/завершена
            const touch = e.changedTouches[0];
            const dx = touch.clientX - startX;
            const dy = touch.clientY - startY;
            if (Math.abs(dx) > Math.abs(dy)) {
                if (dx > 30) move("right");
                else if (dx < -30) move("left");
            } else {
                if (dy > 30) move("down");
                else if (dy < -30) move("up");
            }
        });

        // JS для кнопок та модалок
        const rulesBtn = document.getElementById('rulesBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const controlsBtn = document.getElementById('controlsBtn');

        const rulesModal = document.getElementById('rulesModal');
        const settingsModal = document.getElementById('settingsModal');
        const controlsModal = document.getElementById('controlsModal');

        const langBtn = document.getElementById('langBtn');
        const langPopup = document.getElementById('langPopup');

        const themeBtn = document.getElementById('themeBtn');
        const themePopup = document.getElementById('themePopup');

        const controlsBackBtn = document.getElementById('controlsBackBtn');

        // Мовні словники
        const translations = {
            uk: {
                gameTitle: "NoneUp",
                scoreLabel: "Очки",
                bestLabel: "Рекорд",
                startButton: "Грати", // Для початку нової гри (нижня кнопка)
                playButtonTitle: "Продовжити", // Title для верхньої кнопки Play
                pauseButtonTitle: "Пауза", // Title для верхньої кнопки Pause
                gameOverMessage: "Гру завершено!", // Залишено, якщо ви захочете повернути це повідомлення
                winMessage: "Ви виграли!🎉",
                rulesButton: "Правила",
                settingsButtonTitle: "Налаштування",
                rulesTitle: "Правила гри 2048",
                pcLabel: "На ПК:",
                pcControls: "керуй грою за допомогою стрілок: ← ↑ → ↓ або WASD.",
                phoneLabel: "На телефоні:",
                phoneControls: "керуй грою свайпами вгору, вниз, вліво та вправо.",
                gameGoal: "З'єднуй однакові числа, щоб отримати 2048 і виграти гру!",
                settingsTitle: "Налаштування",
                controlsButton: "Управління",
                languageButton: "Мова ▼",
                themeButton: "Тема ▼",
                darkTheme: "Темна тема",
                lightTheme: "Світла тема",
                controlsTitle: "Управління",
                arrows: "Стрілки: ← ↑ → ↓",
                swipes: "Свайпи вгору, вниз, вліво, вправо",
                closeButton: "Закрити",
                backButton: "Повернутися",
            },
            en: {
                gameTitle: "NoneUp",
                scoreLabel: "Score",
                bestLabel: "Best",
                startButton: "Play",
                playButtonTitle: "Continue",
                pauseButtonTitle: "Pause",
                gameOverMessage: "Game Over!",
                winMessage: "You won!🎉",
                rulesButton: "Rules",
                settingsButtonTitle: "Settings",
                rulesTitle: "2048 Game Rules",
                pcLabel: "On PC:",
                pcControls: "control the game using arrow keys: ← ↑ → ↓ or WASD.",
                phoneLabel: "On Phone:",
                phoneControls: "control the game with swipes up, down, left, and right.",
                gameGoal: "Combine identical numbers to get 2048 and win the game!",
                settingsTitle: "Settings",
                controlsButton: "Controls",
                languageButton: "Language ▼",
                themeButton: "Theme ▼",
                darkTheme: "Dark Theme",
                lightTheme: "Light Theme",
                controlsTitle: "Controls",
                arrows: "Arrows: ← ↑ → ↓",
                swipes: "Swipes up, down, left, right",
                closeButton: "Close",
                backButton: "Back",
            },
            ja: {
                gameTitle: "NoneUp",
                scoreLabel: "スコア",
                bestLabel: "最高記録",
                startButton: "プレイ",
                playButtonTitle: "続行",
                pauseButtonTitle: "一時停止",
                gameOverMessage: "ゲームオーバー！",
                winMessage: "勝利しました！🎉",
                rulesButton: "ルール",
                settingsButtonTitle: "設定",
                rulesTitle: "2048ゲームのルール",
                pcLabel: "PCで:",
                pcControls: "矢印キー: ← ↑ → ↓ または WASD でゲームを操作します。",
                phoneLabel: "スマートフォンで:",
                phoneControls: "上下左右にスワイプしてゲームを操作します。",
                gameGoal: "同じ数字を結合して2048を作り、ゲームに勝利しましょう！",
                settingsTitle: "設定",
                controlsButton: "操作方法",
                languageButton: "言語 ▼",
                themeButton: "テーマ ▼",
                darkTheme: "ダークテーマ",
                lightTheme: "ライトテーマ",
                controlsTitle: "操作方法",
                arrows: "矢印: ← ↑ → ↓",
                swipes: "上下左右のスワイプ",
                closeButton: "閉じる",
                backButton: "戻る",
            },
            zh: {
                gameTitle: "NoneUp",
                scoreLabel: "分数",
                bestLabel: "最高分",
                startButton: "开始",
                playButtonTitle: "继续",
                pauseButtonTitle: "暂停",
                gameOverMessage: "游戏结束！",
                winMessage: "你赢了！🎉",
                rulesButton: "规则",
                settingsButtonTitle: "设置",
                rulesTitle: "2048游戏规则",
                pcLabel: "在电脑上:",
                pcControls: "使用方向键：← ↑ → ↓ 或 WASD 控制游戏。",
                phoneLabel: "在手机上:",
                phoneControls: "向上、向下、向左、向右滑动屏幕来控制游戏。",
                gameGoal: "合并相同的数字以达到2048并赢得游戏！",
                settingsTitle: "设置",
                controlsButton: "控制",
                languageButton: "语言 ▼",
                themeButton: "主题 ▼",
                darkTheme: "深色主题",
                lightTheme: "浅色主题",
                controlsTitle: "控制",
                arrows: "方向键：← ↑ → ↓",
                swipes: "向上、向下、向左、向右滑动",
                closeButton: "关闭",
                backButton: "返回",
            }
        };

        let currentLang = 'uk'; // Мова за замовчуванням

        // Функція для оновлення тексту на сторінці
        function updateTextsForLanguage() {
            document.querySelectorAll('[data-lang-key]').forEach(element => {
                const key = element.getAttribute('data-lang-key');
                if (translations[currentLang] && translations[currentLang][key]) {
                    element.textContent = translations[currentLang][key];
                }
            });

            // Оновлюємо атрибути title для верхніх кнопок
            settingsBtn.title = translations[currentLang]['settingsButtonTitle'];
            // playPauseBtnTop.title оновлюється всередині updateButtonVisibility()
            
            // Оновлюємо атрибут aria-label для кнопок закриття
            // controlsBackBtn тепер не має класу close-btn, тому її title обробляється окремо
            document.querySelectorAll('.close-btn').forEach(btn => {
                btn.setAttribute('aria-label', translations[currentLang]['closeButton']);
            });
            controlsBackBtn.setAttribute('aria-label', translations[currentLang]['backButton']); // Обробка для controlsBackBtn окремо


            // Оновлюємо рекорд при зміні мови, щоб він правильно відображався
            bestDisplay.textContent = localStorage.getItem("best") || 0;
            updateScore(currentScore);
            // gameOverDisplay не оновлюємо тут, його текст керується логікою гри

            // Оновлюємо видимість кнопок після зміни мови, щоб title та іконки були правильні
            updateButtonVisibility();
        }

        // === Обробники подій для кнопок Play/Pause/Start ===

        // Обробник для великої кнопки "Грати" (внизу)
        startBtn.addEventListener('click', () => {
            setupNewGame(); // Завжди починає нову гру
        });

        // Обробник для верхньої кнопки Play/Pause
        playPauseBtnTop.addEventListener('click', () => {
            if (paused) {
                continueGame(); // Якщо на паузі, продовжуємо
            } else {
                pauseGame(); // Якщо граємо, ставимо на паузу
            }
        });
        // =======================================================


        // Встановлюємо початкову мову та видимість кнопок при завантаженні сторінки
        updateTextsForLanguage();
        // setupNewGame() не викликаємо тут, щоб гра не починалася автоматично


        // === Обробники подій для модалок ===

        // Функція для закриття всіх основних модалок
        function closeAllModals() {
            rulesModal.style.display = 'none';
            settingsModal.style.display = 'none';
            controlsModal.style.display = 'none';
        }

        // Функція для закриття всіх міні-попапів (мова, тема)
        function closeAllPopups() {
            langPopup.style.display = 'none';
            themePopup.style.display = 'none';
        }

        // Відкриття Правил
        rulesBtn.onclick = () => {
            closeAllModals(); // Закриваємо всі основні модалки
            closeAllPopups(); // Закриваємо всі міні-попапи
            rulesModal.style.display = 'flex';
        };

        // Відкриття Налаштувань
        settingsBtn.onclick = () => {
            closeAllModals(); // Закриваємо всі основні модалки
            closeAllPopups(); // Закриваємо всі міні-попапи
            settingsModal.style.display = 'flex';
        };

        // Відкриття Управління з Налаштувань
        controlsBtn.onclick = () => {
            closeAllPopups(); // Закриваємо міні-попапи, якщо відкриті
            settingsModal.style.display = 'none';
            controlsModal.style.display = 'flex';
        };

        // Повернення з Управління до Налаштувань
        controlsBackBtn.onclick = (e) => {
            e.stopPropagation(); // Важливо: зупиняємо поширення події, щоб не закрити батьківську модалку
            controlsModal.style.display = 'none';
            settingsModal.style.display = 'flex';
        };

        // Закриття по кнопках закриття (хрестики) - ТЕПЕР ТІЛЬКИ ДЛЯ СПРАВЖНІХ ХРЕСТИКІВ
        document.querySelectorAll('.close-btn').forEach(btn => {
            btn.onclick = e => {
                e.target.closest('.modal-overlay').style.display = 'none';
                closeAllPopups(); // Закриваємо міні-попапи при закритті основних модалок
            };
        });

        // Закриття по кліку поза модалкою
        [rulesModal, settingsModal, controlsModal].forEach(modal => {
            modal.onclick = e => {
                if(e.target === modal) {
                    modal.style.display = 'none';
                    closeAllPopups(); // Закриваємо міні-попапи, якщо клацнули поза модалкою
                }
            };
        });

        // Показ/приховання міні-меню (Мова, Тема)
        langBtn.onclick = e => {
            e.stopPropagation(); // Зупиняємо поширення, щоб клік по кнопці не закрив попап одразу
            if (langPopup.style.display === 'flex') {
                langPopup.style.display = 'none';
            } else {
                closeAllPopups(); // Закриваємо інші попапи (якщо є)
                langPopup.style.display = 'flex';
            }
        };

        themeBtn.onclick = e => {
            e.stopPropagation(); // Зупиняємо поширення, щоб клік по кнопці не закрив попап одразу
            if (themePopup.style.display === 'flex') {
                themePopup.style.display = 'none';
            } else {
                closeAllPopups(); // Закриваємо інші попапи (якщо є)
                themePopup.style.display = 'flex';
            }
        };

        // Закрити міні-меню при кліку поза ними
        document.body.addEventListener('click', () => {
            closeAllPopups();
        });

        // Обробка вибору мови
        langPopup.querySelectorAll('button').forEach(btn => {
            btn.onclick = e => {
                currentLang = e.target.getAttribute('data-lang');
                updateTextsForLanguage(); // Викликаємо функцію для оновлення всіх текстів
                closeAllPopups(); // Закриваємо попап мови
            };
        });

        // Обробка вибору теми
        themePopup.querySelectorAll('button').forEach(btn => {
            btn.onclick = e => {
                const theme = e.target.getAttribute('data-theme');
                if(theme === 'light') {
                    document.body.classList.add('light');
                } else {
                    document.body.classList.remove('light');
                }
                closeAllPopups(); // Закриваємо попап теми
            };
        });
    </script>

</body>
</html>